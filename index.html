<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OB弹幕播放器</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        .artplayer-app { width: 100%; height: 100%; }
        
        /* 现代化通知系统样式 */
        .notifications-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 90%;
            width: 300px;
        }
        
        @media (max-width: 480px) {
            .notifications-container {
                top: 10px;
                right: 10px;
                width: calc(100% - 20px);
            }
        }
        
        .notification {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 8px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
        }
        
        .notification.success {
            background: linear-gradient(to right, rgba(46, 204, 113, 0.9), rgba(39, 174, 96, 0.9));
        }
        
        .notification.error {
            background: linear-gradient(to right, rgba(231, 76, 60, 0.9), rgba(192, 57, 43, 0.9));
        }
        
        .notification.loading {
            background: linear-gradient(to right, rgba(52, 152, 219, 0.9), rgba(41, 128, 185, 0.9));
        }
        
        .notification.info {
            background: linear-gradient(to right, rgba(52, 73, 94, 0.9), rgba(44, 62, 80, 0.9));
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification-icon {
            margin-right: 10px;
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-content {
            flex-grow: 1;
            word-break: break-word;
        }
        
        .notification-close {
            margin-left: 10px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }
        
        .notification-close:hover {
            opacity: 1;
        }
        
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.3);
            width: 100%;
            transform-origin: left;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spin {
            animation: spin 1.5s linear infinite;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer-plugin-danmuku/dist/artplayer-plugin-danmuku.js"></script>
</head>
<body>
<div class="artplayer-app"></div>
<div class="notifications-container" id="notifications-container"></div>

<script>
function getUrlParameter(name) {
    const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

// 现代化通知系统
const notification = {
    container: document.getElementById('notifications-container'),
    activeNotifications: {},
    icons: {
        success: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
        error: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`,
        loading: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`,
        info: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`,
        close: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`
    },
    
    show(message, type = 'success', duration = 3000) {
        console.log(`[通知] 类型: ${type}, 信息: ${message}`);
        
        // 创建通知元素
        const id = Date.now();
        const notificationEl = document.createElement('div');
        notificationEl.className = `notification ${type}`;
        notificationEl.innerHTML = `
            <div class="notification-icon">${this.icons[type] || this.icons.info}</div>
            <div class="notification-content">${message}</div>
            <div class="notification-close">${this.icons.close}</div>
            ${duration > 0 && type !== 'loading' ? '<div class="notification-progress"></div>' : ''}
        `;
        
        // 添加到容器
        this.container.appendChild(notificationEl);
        this.activeNotifications[id] = {
            element: notificationEl,
            timeout: null,
            progressInterval: null
        };
        
        // 显示通知（添加动画类）
        setTimeout(() => {
            notificationEl.classList.add('show');
        }, 10);
        
        // 设置进度条动画
        if (duration > 0 && type !== 'loading') {
            const progressEl = notificationEl.querySelector('.notification-progress');
            let progress = 100;
            const interval = 100; // 更新间隔（毫秒）
            const step = 100 / (duration / interval);
            
            this.activeNotifications[id].progressInterval = setInterval(() => {
                progress -= step;
                if (progress <= 0) {
                    clearInterval(this.activeNotifications[id].progressInterval);
                    progress = 0;
                }
                progressEl.style.transform = `scaleX(${progress / 100})`;
            }, interval);
            
            // 设置自动关闭
            this.activeNotifications[id].timeout = setTimeout(() => {
                this.hide(id);
            }, duration);
        }
        
        // 添加关闭按钮事件
        const closeBtn = notificationEl.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
            this.hide(id);
        });
        
        return id;
    },
    
    hide(id) {
        const notification = this.activeNotifications[id];
        if (!notification) return;
        
        // 清除定时器
        if (notification.timeout) {
            clearTimeout(notification.timeout);
        }
        if (notification.progressInterval) {
            clearInterval(notification.progressInterval);
        }
        
        // 添加退出动画
        notification.element.classList.remove('show');
        
        // 移除元素
        setTimeout(() => {
            if (notification.element.parentNode) {
                notification.element.parentNode.removeChild(notification.element);
            }
            delete this.activeNotifications[id];
        }, 300);
    },
    
    hideAll() {
        Object.keys(this.activeNotifications).forEach(id => {
            this.hide(id);
        });
    }
};

// 显示初始加载通知
const loadingId = notification.show('正在加载播放器...', 'loading');

const videoUrl = getUrlParameter('url') || '/assets/sample/video.mp4';
const danmakuUrl = getUrlParameter('dmk') || '/assets/sample/danmuku.xml';

document.addEventListener('DOMContentLoaded', function () {
    try {
        const art = new Artplayer({
            container: '.artplayer-app',
            url: videoUrl,
            autoSize: false,
            fullscreen: true,
            playbackRate: true,
            miniProgressBar: true,
            autoPlayback: true,
            fastForward: true,
            plugins: [
                artplayerPluginDanmuku({
                    danmuku: danmakuUrl,
                    speed: 5,
                    margin: [10, '0%'],
                    opacity: 1,
                    color: '#FFFFFF',
                    mode: 0,
                    heatmap: true,
                    points: [],
                    modes: [0, 1, 2],
                    fontSize: 20,
                    antiOverlap: true,
                    emitter: true,
                    maxLength: 200,
                    lockTime: 5,
                    theme: 'dark',
                    beforeEmit(danmu) {
                        return new Promise(resolve => {
                            const content = danmu.text.trim();
                            if (!content) {
                                notification.show('弹幕不能为空！', 'error', 2000);
                                return resolve(false);
                            }

                            const currentTime = art.currentTime || 0;
                            const postData = {
                                dmkUrl: danmakuUrl,
                                text: content,
                                time: currentTime,
                                color: danmu.color,
                                mode: danmu.mode
                            };

                            fetch('sendDanmu.php', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(postData)
                            })
                            .then(res => res.text())
                            .then(() => notification.show('弹幕发送成功', 'success', 2000))
                            .catch(err => {
                                notification.show('弹幕发送失败', 'error', 3000);
                                console.error('弹幕发送失败:', err);
                            })
                            .finally(() => resolve(true));
                        });
                    }
                }),
            ],
        });

        art.on('ready', () => {
            notification.hide(loadingId);
            notification.show('数据获取成功', 'success', 2000);
        });
        
        art.on('error', () => notification.show('视频加载失败', 'error', 5000));
        
        art.on('artplayerPluginDanmuku:loaded', danmus =>
            notification.show(`已加载 ${danmus.length} 条弹幕`, 'info', 3000)
        );
    } catch (error) {
        notification.hide(loadingId);
        notification.show('播放器初始化失败', 'error', 0);
        console.error('播放器初始化失败:', error);
    }
});
</script>
</body>
</html>