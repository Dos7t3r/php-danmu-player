<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OldBili Player | 在线用户</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2.0/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css">
    <style>
        .content-wrapper {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
        }
        .card {
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .table td {
            vertical-align: middle;
        }
        .online-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #28a745;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .refresh-btn {
            cursor: pointer;
            transition: transform 0.3s;
        }
        .refresh-btn:hover {
            color: #007bff;
            transform: rotate(180deg);
        }
        .user-agent-info {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .info-box {
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .info-box:hover {
            transform: translateY(-3px);
        }
        .info-box-icon {
            border-radius: 10px 0 0 10px;
        }
        .auto-refresh-toggle {
            cursor: pointer;
        }
        .auto-refresh-toggle input:checked + .slider {
            background-color: #667eea;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider:before {
            transform: translateX(18px);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            margin-bottom: 0;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .video-link {
            color: #667eea;
            text-decoration: none;
        }
        .video-link:hover {
            text-decoration: underline;
        }
        .user-id-cell {
            font-family: monospace;
            font-size: 0.9em;
        }
        .last-active-time {
            white-space: nowrap;
        }
        .table-responsive {
            min-height: 300px;
        }
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            color: #aaa;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/" class="nav-link">首页</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/admin/profile" class="nav-link">个人资料</a>
            </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                    <i class="fas fa-expand-arrows-alt"></i>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/logout" role="button" title="退出登录">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </li>
        </ul>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="/admin/index" class="brand-link">
            <span class="brand-text font-weight-light">OldBili Player</span>
            <span class="float-right badge badge-success">v2.0</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar user panel (optional) -->
            <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                <div class="image">
                    <i class="fas fa-user-circle fa-2x text-info"></i>
                </div>
                <div class="info">
                    <a href="/admin/profile" class="d-block">{$Think.session.admin.nickname}</a>
                </div>
            </div>

            <!-- Sidebar Menu -->
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                    <li class="nav-item">
                        <a href="/admin/index" class="nav-link">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>控制面板</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/videos" class="nav-link">
                            <i class="nav-icon fas fa-video"></i>
                            <p>视频管理</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/importXml" class="nav-link">
                            <i class="nav-icon fas fa-file-import"></i>
                            <p>导入XML弹幕</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/onlineUsers" class="nav-link active">
                            <i class="nav-icon fas fa-users"></i>
                            <p>在线用户</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/settings" class="nav-link">
                            <i class="nav-icon fas fa-cog"></i>
                            <p>系统设置</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/logs" class="nav-link">
                            <i class="nav-icon fas fa-history"></i>
                            <p>操作日志</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/profile" class="nav-link">
                            <i class="nav-icon fas fa-user"></i>
                            <p>个人资料</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/admin/logout" class="nav-link">
                            <i class="nav-icon fas fa-sign-out-alt"></i>
                            <p>退出登录</p>
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">在线用户</h1>
                    </div><!-- /.col -->
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/admin/index">首页</a></li>
                            <li class="breadcrumb-item active">在线用户</li>
                        </ol>
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.container-fluid -->
        </div>
        <!-- /.content-header -->

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <!-- 统计卡片 -->
                <div class="row">
                    <div class="col-md-3 col-sm-6 col-12">
                        <div class="info-box">
                            <span class="info-box-icon bg-info"><i class="fas fa-users"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">当前在线</span>
                                <span class="info-box-number" id="total-online-count">{$count}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 col-12">
                        <div class="info-box">
                            <span class="info-box-icon bg-warning"><i class="fas fa-clock"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">超时设置</span>
                                <span class="info-box-number">{$timeout} 秒</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6 col-12">
                        <div class="info-box">
                            <span class="info-box-icon bg-danger"><i class="fas fa-chart-line"></i></span>
                            <div class="info-box-content">
                                <span class="info-box-text">自动刷新</span>
                                <div class="d-flex align-items-center mt-1">
                                    <label class="switch mr-2">
                                        <input type="checkbox" id="autoRefreshToggle" checked>
                                        <span class="slider"></span>
                                    </label>
                                    <span id="refreshCountdown">30s</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.row -->

                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-users mr-1"></i>
                                    在线用户列表
                                </h3>
                                <div class="card-tools">
                                    <div class="input-group input-group-sm" style="width: 250px;">
                                        <input type="text" id="searchInput" class="form-control float-right" placeholder="搜索IP或浏览器...">
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-default" id="refreshBtn" title="刷新列表">
                                                <i class="fas fa-sync-alt refresh-btn"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="onlineUsersTable">
                                        <thead>
                                            <tr>
                                                <th style="width: 50px">状态</th>
                                                <th>用户ID</th>
                                                <th>IP地址</th>
                                                <th>正在观看</th>
                                                <th>浏览器</th>
                                                <th>最后活跃时间</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {empty name="onlineUsers"}
                                                <tr>
                                                    <td colspan="7">
                                                        <div class="empty-state">
                                                            <i class="fas fa-users-slash"></i>
                                                            <p>暂无在线用户</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            {else/}
                                                {volist name="onlineUsers" id="user"}
                                                    <tr data-user-id="{$user.user_id}">
                                                        <td><span class="online-badge" title="在线"></span></td>
                                                        <td class="user-id-cell" title="{$user.user_id}">{$user.user_id|substr=0,12}...</td>
                                                        <td>{$user.ip_address|default='未知'}</td>
                                                        <td>
                                                            {if !empty($user.video_id)}
                                                                <a href="/?obv={$user.video_id}" target="_blank" class="video-link">{$user.video_title}</a>
                                                            {else/}
                                                                <span class="text-muted">未观看视频</span>
                                                            {/if}
                                                        </td>
                                                        <td>
                                                            <div class="user-agent-info" title="{$user.user_agent|default='未知'}">
                                                                {$user.user_agent|default='未知'|substr=0,50}...
                                                            </div>
                                                        </td>
                                                        <td class="last-active-time">{$user.last_active}</td>
                                                    </tr>
                                                {/volist}
                                            {/empty}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!-- /.card-body -->
                            <div class="card-footer">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="text-muted">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            在线超时时间: {$timeout} 秒 (可在系统设置中修改)
                                        </span>
                                    </div>
                                    <div>
                                        <span class="text-muted">最后更新时间: <span id="lastUpdateTime">{:date('Y-m-d H:i:s')}</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /.card -->
                    </div>
                </div>
                <!-- /.row -->

                <!-- 图表卡片 -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-chart-pie mr-1"></i>
                                    视频观看分布
                                </h3>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="chart-container" style="position: relative; height: 250px;">
                                            <canvas id="videoDistributionChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="table-responsive">
                                            <table class="table table-sm" id="videoDistributionTable">
                                                <thead>
                                                    <tr>
                                                        <th>视频ID</th>
                                                        <th>标题</th>
                                                        <th>观看人数</th>
                                                        <th>占比</th>
                                                    </tr>
                                                </thead>
                                                <tbody>

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- /.card-body -->
                        </div>
                        <!-- /.card -->
                    </div>
                </div>
                <!-- /.row -->
            </div><!--/. container-fluid -->
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <!-- Main Footer -->
    <footer class="main-footer">
        <strong>Copyright &copy; 2023-2024 <a href="https://github.com/oldbili/oldbiliplayer">OldBili Player</a>.</strong>
        All rights reserved.
        <div class="float-right d-none d-sm-inline-block">
            <b>Version</b> 2.0.0
        </div>
    </footer>
</div>
<!-- ./wrapper -->

<!-- REQUIRED SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2.0/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script>
$(function() {
    // 初始化变量
    let autoRefreshEnabled = true;
    let countdownInterval;
    let countdownValue = 30;
    let currentUserIdToKick = null;
    let chart = null;
    
    // 初始化图表
    updateVideoDistribution();
    initChart();
    
    // 刷新按钮点击事件
    $('#refreshBtn').on('click', function() {
        refreshData();
        $(this).find('i').addClass('fa-spin');
        setTimeout(() => {
            $(this).find('i').removeClass('fa-spin');
        }, 1000);
    });
    
    // 自动刷新开关
    $('#autoRefreshToggle').on('change', function() {
        autoRefreshEnabled = $(this).prop('checked');
        if (autoRefreshEnabled) {
            startCountdown();
        } else {
            stopCountdown();
            $('#refreshCountdown').text('已关闭');
        }
    });
    
    // 搜索功能
    $('#searchInput').on('keyup', function() {
        const value = $(this).val().toLowerCase();
        $("#onlineUsersTable tbody tr").filter(function() {
            const ipText = $(this).find('td:eq(2)').text().toLowerCase();
            const browserText = $(this).find('td:eq(4)').text().toLowerCase();
            const videoText = $(this).find('td:eq(3)').text().toLowerCase();
            const match = ipText.indexOf(value) > -1 || browserText.indexOf(value) > -1 || videoText.indexOf(value) > -1;
            $(this).toggle(match);
        });
    });
    
    // 开始自动刷新倒计时
    startCountdown();
    
    // 函数：开始倒计时
    function startCountdown() {
        countdownValue = 30;
        updateCountdownDisplay();
        
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        countdownInterval = setInterval(function() {
            countdownValue--;
            updateCountdownDisplay();
            
            if (countdownValue <= 0) {
                refreshData();
                countdownValue = 30;
            }
        }, 1000);
    }
    
    // 函数：停止倒计时
    function stopCountdown() {
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    }
    
    // 函数：更新倒计时显示
    function updateCountdownDisplay() {
        $('#refreshCountdown').text(countdownValue + 's');
    }
    
    // 函数：刷新数据
    function refreshData() {
        $.ajax({
            url: window.location.href,
            type: 'GET',
            dataType: 'html',
            success: function(response) {
                // 解析HTML响应
                const parser = new DOMParser();
                const doc = parser.parseFromString(response, 'text/html');
                
                // 更新表格内容
                const newTableBody = $(doc).find('#onlineUsersTable tbody').html();
                $('#onlineUsersTable tbody').html(newTableBody);
                
                // 更新统计数据
                const newTotalCount = $(doc).find('#total-online-count').text();
                $('#total-online-count').text(newTotalCount);
                
                // 更新最后更新时间
                $('#lastUpdateTime').text(new Date().toLocaleString());
                
                // 更新视频分布数据
                updateVideoDistribution();
                
                // 更新图表
                updateChart();
                
                // 应用当前搜索过滤
                const searchValue = $('#searchInput').val().toLowerCase();
                if (searchValue) {
                    $("#onlineUsersTable tbody tr").filter(function() {
                        const ipText = $(this).find('td:eq(2)').text().toLowerCase();
                        const browserText = $(this).find('td:eq(4)').text().toLowerCase();
                        const videoText = $(this).find('td:eq(3)').text().toLowerCase();
                        const match = ipText.indexOf(searchValue) > -1 || browserText.indexOf(searchValue) > -1 || videoText.indexOf(searchValue) > -1;
                        $(this).toggle(match);
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error('刷新数据失败:', error);
            }
        });
    }
    
    // 函数：更新用户计数
    function updateUserCounts() {
        const totalCount = $("#onlineUsersTable tbody tr:visible").length;
        const watchingCount = $("#onlineUsersTable tbody tr:visible td:nth-child(4) a").length;
        
        $('#total-online-count').text(totalCount);
        $('#watching-count').text(watchingCount);
    }
    
    // 函数：更新视频分布数据
    function updateVideoDistribution() {
        // 清空表格
        $('#videoDistributionTable tbody').empty();
        
        // 收集视频观看数据
        const videoData = {};
        let totalWatching = 0;
        
        // 遍历在线用户表格中的视频数据
        $("#onlineUsersTable tbody tr").each(function() {
            const videoLink = $(this).find('td:eq(3) a');
            if (videoLink.length > 0) {
                const videoId = videoLink.attr('href').split('=')[1];
                const videoTitle = videoLink.text();
                
                if (!videoData[videoId]) {
                    videoData[videoId] = {
                        id: videoId,
                        title: videoTitle,
                        count: 0
                    };
                }
                
                videoData[videoId].count++;
                totalWatching++;
            }
        });
        
        // 转换为数组并按观看人数排序
        const sortedVideos = Object.values(videoData).sort((a, b) => b.count - a.count);
        
        // 填充表格
        if (sortedVideos.length === 0) {
            $('#videoDistributionTable tbody').html('<tr><td colspan="4" class="text-center">暂无观看数据</td></tr>');
        } else {
            sortedVideos.forEach(video => {
                const percentage = ((video.count / totalWatching) * 100).toFixed(1);
                $('#videoDistributionTable tbody').append(`
                    <tr>
                        <td>${video.id}</td>
                        <td><a href="/?obv=${video.id}" target="_blank" class="video-link">${video.title}</a></td>
                        <td>${video.count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `);
            });
        }
    }
    
    // 函数：初始化图表
    function initChart() {
        const ctx = document.getElementById('videoDistributionChart').getContext('2d');
        
        // 收集数据
        const labels = [];
        const data = [];
        const backgroundColors = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
            '#6f42c1', '#fd7e14', '#20c9a6', '#5a5c69', '#858796'
        ];
        
        // 从表格中获取数据
        $('#videoDistributionTable tbody tr').each(function() {
            const title = $(this).find('td:eq(1) a').text();
            const count = parseInt($(this).find('td:eq(2)').text(), 10);
            
            if (!isNaN(count)) {
                labels.push(title);
                data.push(count);
            }
        });
        
        // 如果没有数据，显示空状态
        if (data.length === 0) {
            if (chart) {
                chart.destroy();
                chart = null;
            }
            
            // 显示无数据提示
            $('#videoDistributionChart').parent().html(`
                <div class="empty-state" style="height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <i class="fas fa-chart-pie" style="font-size: 48px; color: #ddd; margin-bottom: 10px;"></i>
                    <p style="color: #aaa;">暂无视频观看数据</p>
                </div>
            `);
            return;
        }
        
        // 如果已有图表，先销毁
        if (chart) {
            chart.destroy();
        }
        
        // 创建图表
        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, data.length),
                    hoverBackgroundColor: backgroundColors.slice(0, data.length),
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        titleFont: {
                            size: 14
                        },
                        bodyFont: {
                            size: 14
                        },
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '70%',
                elements: {
                    arc: {
                        borderWidth: 1
                    }
                }
            }
        });
    }
    
    // 函数：更新图表
    function updateChart() {
        initChart();
    }
});
</script>
</body>
</html>
